<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netzyn</title>
    <script src="../NzPlayerWebBrowser.js?cachebuster=Math.random()"></script>

    <style>
        :root {
            /* --height-dvh: 100vh; */
            --width-dvw: 100%;
            --height-dvh: 100%;
        }
        body,
        html {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--width-dvw);
            height: var(--height-dvh);
            font-family: Arial, sans-serif;
            background-color: #01203a !important;
        }

        .box {
            background: #01203a;
            object-fit: fill;
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        video {
            background: black;
            object-fit: fill;
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        /* Top bar styling */
        .top-bar {
            width: 100%;
            height: 50px;
            /* background-color: #01203a; */
            background-color: #FFFFFF;
            color: #fff;
            flex-direction: row;
            display: flex;
            justify-content: space-between;
            /* Distribute buttons evenly */
            align-items: center;
            /* Align items vertically in the center */
            position: fixed;
            /* top: 0; */ /* bar at top */
            bottom: 0; /* bar at bottom */
            left: 0;
            z-index: 1000;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            /* Add some padding for spacing */
        }

        .sub-bar {
            width: 100%;
            height: 50px;
            display: flex;
            /* background-color: #01203a; */
            background-color: #FFFFFF;
            color: #fff;
            display: flex;
            justify-content: flex-end;
            flex-direction: row;
            /* Distribute buttons evenly */
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            row-gap: 3px;
            /* Add some padding for spacing */
        }


        /* Button styling */
        .start-button {
            padding: 8px 18px;
            color: #000000;
            background-color: #ffffff;
            /* Add a background color for contrast */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .start-button-container {
            padding: 8px 18px;
            color: #000000;
            background-color: #ffffff;
            /* Add a background color for contrast */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-direction: row;
            
            }        

        .install-button {
            gap:3px;
            height: 50%;
            padding: 8px 18px;
            color: #000000;
            /* background-color: #f3cd25; */
            background-color: white;
            /* Add a background color for contrast */
            box-shadow: 1px 1px 3px rgba(136, 136, 136, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            opacity: 100%;
        }

        #app_run {
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        .close-button {
            padding: 4px 9px;
            color: #ffffff;
            background-color: white;
            /* Add a background color for contrast */
            box-shadow: 1px 1px 3px rgba(136, 136, 136, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            opacity: 100%;
        }

        /* For portrait orientation */
        @media screen and (orientation: portrait) {
            .top-bar {
                width: 100%;
                justify-content: flex-start;
                /* Ensure the button is aligned correctly */
            }

            .start-button {
                font-size: 22x;
            }
        }

        /* For landscape orientation */
        @media screen and (orientation: landscape) {
            .top-bar {
                width: 100%;
                justify-content: flex-end;
                /* Ensure the button is aligned correctly */
            }

            .start-button {
                font-size: 22x;
            }

        }
        
        .install-arrow-box {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            font-color: #000000;
            background-color: #ADD8E6;

        }      
        
        #rotatescreenlanscape {
            /* width: 100%; */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            object-fit: cover;
            background: #01203a;
            margin: 0 !important;
            z-index: 9999;
            touch-action: none;


        }

        #rotatescreenportrait {
            /* width: 100%; */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            object-fit: scale-down;
            background: #01203a;
            margin: 0 !important;
            z-index: 9999;
            touch-action: none;
        }
        .content {
            display: flex;
            align-items: center;
            color: white;
            text-align: center;
        }

    </style>
</head>

<body>
    <div id="app_run" >
        <img id="rotatescreenlanscape" src="assets/rotate-L.gif" />
        <img id="rotatescreenportrait" src="assets/rotate-P.gif" />
        <div class="top-bar" id="apprun_topbar">
            <div style="justify-content: flex-start;" class="sub-bar">
                <div class="app-icon" style="place-items: center;margin-top: 5px;" id="netzyn_logo="><img src="assets/netzyn_logo-05.svg" width="75" height="30"/></div>
            </div>

            <div class="sub-bar">
                <div class="start-button-container">
                    
                    <img src="assets/timer.svg">
                    <button class="start-button" style="padding-right: 0%;margin-right: 0%;padding-left: 0%;margin-left: 10%;" id="timer">5:00</button>
                </div>            
                <button style="display: flex; align-items: center; gap: 5px; margin-right: 10px;border: none;" class="install-button" id="install" onclick="handleInstall()">
                    <img src="assets/install.svg" alt="Install Icon" style="height: 16px; width: 16px;">
                    Install
                </button>
                                <button style="margin-right: 20px;border: none;" class="close-button" id="close" onclick="handleOnClick()"><img src="assets/XButton.svg"/></button>
                                <p></p>
            </div>
        </div>

        <div visibility: visible class="box" id="where_to_put_the_video" object-fit="fill" background="black"
            tabindex="-1"></div>

    </div>

    <script>
        let g_WaitForStartTimerId   = 0;
        let g_WaitForStartTimeout   = 10000; // 10seconds
        let g_BackOnClose           = true;

	let didResize = false;
        function detectRotationToPortrait(timeoutId) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Check if it switched to portrait
            if (width < height) {
                console.log("Device rotated to Portrait - Showing screen cover");
		        didResize = true;
                const element = document.getElementById("rotatescreenportrait");
                element.style.display = "none"; // Hide the cover
                element.remove(); // Optionally remove the element

                clearTimeout(timeoutId); // Stop the timeout (no redirect)
                //alert("Device rotated to portrait, launching player...");

                // Initialize video player after rotation is detected
                initializeV(); // Call your video initialization function (if any)

                // Now that the rotation is handled, launch the player
                launchNzPlayer(app, 'P');  // Use portrait orientation
            }

        }
        function detectRotationToLandscape(timeoutId) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Check if it switched to portrait
            if (width > height) {
                console.log("Device rotated to LandScape - Showing screen cover");
		        didResize = true;
                const element = document.getElementById("rotatescreenlanscape");
                element.style.display = "none"; // Hide the cover
                element.remove(); // Optionally remove the element

                clearTimeout(timeoutId); // Stop the timeout (no redirect)
                //alert("Device rotated to portrait, launching player...");

                // Initialize video player after rotation is detected
                initializeV(); // Call your video initialization function (if any)

                // Now that the rotation is handled, launch the player
                launchNzPlayer(app, 'L');  // Use portrait orientation
            }

        }
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        function initializeV()
        {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            const topBar = document.querySelector(".top-bar");
            const appRun = document.getElementById("app_run");
            const playArea = document.getElementById("where_to_put_the_video");
            let bBarTop = false; // TODO check if bar at top or bottom, but the quick method is to hard code it!

            if(topBar == null)
                return;

            if(bBarTop)
            {
                if (window.matchMedia("(orientation: portrait)").matches) {
                    // Portrait: Adjust height minus toolbar
                    const topBarHeight = topBar.offsetHeight;
                    appRun.style.width = screenWidth + "px";
                    appRun.style.height = (screenHeight - topBarHeight) + "px";
                    playArea.style.width = screenWidth + "px";
                    playArea.style.height = (screenHeight - topBarHeight) + "px";
                    appRun.style.marginTop = `${topBarHeight}px`; // Fixed syntax
                } else {
                    // Landscape: Adjust width minus toolbar
                    const topBarWidth = topBar.offsetWidth;
                    appRun.style.width = `${screenWidth - topBarWidth}px`;
                    appRun.style.height = `${screenHeight}px`;
                    playArea.style.width = `${screenWidth - topBarWidth}px`;
                    playArea.style.height = `${screenHeight}px`;
                    appRun.style.marginLeft = `${topBarWidth}px`; // Fixed syntax
                }
            }
            else
            {
                    const topBarHeight = topBar.offsetHeight;
                    appRun.style.width = screenWidth + "px";
                    appRun.style.height = (screenHeight - topBarHeight) + "px";
                    playArea.style.width = screenWidth + "px";
                    playArea.style.height = (screenHeight - topBarHeight) + "px";
                    appRun.style.marginBottom = `${topBarHeight}px`; // Fixed syntax
            }

        }

        window.addEventListener("load", () => {
            initializeV();
            window.addEventListener('resize',function(){
                //when the browser window is resized; recalculate
                initializeV();
            });            

        });

        let app = new URLSearchParams(window.location.search).get("app");
        let orientation = new URLSearchParams(window.location.search).get("orient");
        let install = new URLSearchParams(window.location.search).get("install");
        let install_ios = new URLSearchParams(window.location.search).get("install_ios");
        let backOnClose = new URLSearchParams(window.location.search).get("back");
        let no_install = (install == null || install =="");
        let no_install_ios = (install_ios == null || install_ios =="");

        if(backOnClose == null )
            g_BackOnClose = false;
        else if(backOnClose=="true")
            g_BackOnClose = true;
        else
            g_BackOnClose = false;

        if(app == null || app == "")
        {
            const alertMsg = "App url param is missing";
        }

        if(orientation == null || orientation == "")
            orientation = "L";

        // Handle missing install links
        if (no_install && no_install_ios) {
            console.log("App install url missing");
        } else if (no_install && !no_install_ios) {
            if (isIOS()) {
                install = install_ios;
            } else {
                console.log("Android install URL missing and device is not iOS");
            }
        } else if (!no_install && no_install_ios) {
            // Use Android link (already in `install`)
            // Nothing needs to change
        } else {
            // Both links present
            if (isIOS()) {
                install = install_ios;
            }
        }


        let timerleft = 300;

        if(localStorage != null && app != null)
        {
            timeLeft = localStorage.getItem(app);
        }

        //*************************************************************************
        // for this exmaple, so the timer never expires, always start at 300seconds time remaining
        timeLeft = 300
        //*************************************************************************

        const timerDisplay = document.getElementById("timer");

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.src = "./assets/timer.svg";
            timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            timeLeft--;

            //*************************************************************************
            // for this example, disable saving the time remaining
            // if (localStorage != null)
            //     localStorage.setItem(app, timeLeft <= 0 ? 0 : timeLeft);
            //*************************************************************************

            if (timeLeft <= 0) { 
                const installButton = document.getElementById("install");
                console.log("pre_applaunch:navigateToPage3:setinterval installbutton=", installButton);

                const alertMsg = "Demo time has been exhausted";
                alert(alertMsg);

                if(installButton != null)
                    installButton.click();
                else
                {
                    window.close();
                    goBack();
                }
            }
            else
                setTimeout(updateTimer, 1000);

        }

        const closeButton = document.getElementById("close");
        if(closeButton != null)
        {
            closeButton.onclick = () => {
                console.log("apprun_close onclick");
                window.close();
                goBack();
            };
        }
        
        const installButton = document.getElementById("install");
        if(installButton != null && install != null && install != "")
        {
            installButton.onclick = () => window.location.href = `${install}`;
        }
        installButton.onclick = () => {
            window.open(install, "_blank");
            window.close();
            goBack();
        };

        //------------------------------------------------------------------------------
        // callbackWebPlayerStatus
        //! WebPlayer callback with status
        //!
        //! @param [in] statusId    Event status ID
        //------------------------------------------------------------------------------
        function callbackWebPlayerStatus(statusId)
        {
            clearTimeout(g_WaitForStartTimerId);
            g_WaitForStartTimerId = 0;

            switch(statusId)
            {
                case NZWEBPLAYER_STATUS_UNSUPPORTED_BROWSER:
                    alert("Sorry, this browser is not supported.");
                    break;

                case NZWEBPLAYER_STATUS_STARTED:
                    updateTimer();
                    return;
                    break;

                default:
                    alert("Sorry, the app has closed");
                    break;
            }

            window.close();
            goBack();

        }

        //------------------------------------------------------------------------------
        // randomUserName
        //! Return a string of given length with random letters
        //! EX:
        //!     length=5; return "ABCDE"
        //!     length=5; return "ZWXYZ"
        //!
        //! @param [in] length      - Length of string to return
        //!
        //! @return string of specified length
        //------------------------------------------------------------------------------
        function randomUserName(length) {
            let result = '';
            const characters = 'ab01cdefghijklmnopqrst23uvwxy4z5ABCDEFG67HIJKLMNOPQR89STUVWXYZ'; 
            const charactersLength = characters.length;

            let counter = 0;
            while (counter < length)
            {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
                counter += 1;
            }

            return result;
        }

        //------------------------------------------------------------------------------
        // setCookie
        //! Helper to set a cookie
        //!
        //! @param [in] name        keyname
        //! @param [in] value       data to store
        //! @param [in] days        When cookie will expire
        //------------------------------------------------------------------------------
        function setCookie(name, value, days) 
        {
            let expires = "";
            if (days) 
            {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
        }

        //------------------------------------------------------------------------------
        // getCookie
        //! Helper to get a cookie
        //!
        //! @param [in] name        keyname
        //!
        //! @returns value of cookie
        //! @returns null if cookie not found
        //------------------------------------------------------------------------------
        function getCookie(name) 
        {
            const cookies = document.cookie.split('; ');
            for (let i = 0; i < cookies.length; i++) 
            {
                const parts = cookies[i].split('=');
                if (parts[0] === name) 
                {
                    return parts[1];
                }
            }
            return null;
        }

        //------------------------------------------------------------------------------
        // getUserName
        //! Get username
        //!     If username cookie not found, create a random username and save it as a cookie.
        //!
        //! @returns username string
        //------------------------------------------------------------------------------
        function getUserName() 
        {
            let username = getCookie("Username");
            if(username == null || username == "")
            {
                username = randomUserName(15);

                let days=365;
                console.log("New Username =", username);
                setCookie("Username", username, days);
            }
            return username;
        }

        //------------------------------------------------------------------------------
        // startNzPlayer
        //! Start the process to launch the webplayer
        //!     Check for correct orientation, if orientation is not correct allow a few
        //!     seconds for the suer to rotate to the correct orientation.
        //!
        //------------------------------------------------------------------------------
        function startNzPlayer() {
            let app = new URLSearchParams(window.location.search).get("app");
            let orientation = new URLSearchParams(window.location.search).get("orient");
            console.log("this is the given orientation" + orientation)

            if(app == null || app == "")
            {
                const alertMsg = "App url param is missing";
                return;
            }

            if (orientation == null || orientation == "")
            {
                if( app.includes("_l"))
                    orientation = "L";
                else
                    orientation = "P";
            }
        
            orientation = orientation.toUpperCase()
            // move to started callback
            //updateTimer();

            const width = window.innerWidth;
            const height = window.innerHeight;
            var bLaunch = true;

            if (orientation == 'L' && height > width) {
                console.log("navigateToPage3 landscape");
                const element = document.getElementById("rotatescreenlanscape");
                const content = document.getElementById("content");

                element.style.display = "block";
                window.addEventListener("resize", detectRotationToLandscape);

                setTimeout(() => {
                    element.style.display = "none";
                    timeLeft += 4;
                    if(localStorage != null)
                        localStorage.setItem(app, timeLeft);
                    if(!didResize){
                        window.close();
                        goBack();
                    }
                }, 5000);

                bLaunch = false;
            }

            if (orientation == 'P' && height < width) {
                console.log("navigateToPage3 portrait");

                const element = document.getElementById("rotatescreenportrait");
                const content = document.getElementById("content");

                element.style.display = "block";
                window.addEventListener("resize", detectRotationToPortrait);

                // The timeout ensures the rotation handling is only after a certain period.
                setTimeout(() => {
                    element.style.display = "none";
                    timeLeft += 4;
                    if(localStorage != null)
                        localStorage.setItem(app, timeLeft);
                    if(!didResize){
                        window.close();
                        goBack();
                    }

                }, 5000);
                
                bLaunch = false;
            }

            // Only launch if no rotation needed or after rotation is done
            if (bLaunch) {
                launchNzPlayer(app, orientation);
            }
        }

        function goBack()
        {
            if(g_BackOnClose == true)
            {
                if(isIOS())
                    history.go(-(window.history.length - 1));        
                else
                    window.history.back();
            }
            else
                window.location.replace("./pleaseclose.html");

            // if(isIOS())
            // {
            //     if(window.history.length > 1)
            //     {
            //         history.go(-(window.history.length - 1));        
            //     }
            //     else
            //         window.location.replace("./pleaseclose.html");
            // }
            // else
            // {
            //     window.history.back();
            // }
        }
        
        function waitForStart()
        {
            console.log("waitForStart, show thanks 0");
            //goBack();
            //window.location.href = "_blank";
            //window.location.href = "./thanks.html";

            if(isIOS())
            {
                if(window.history.length > 1)
                {
                    history.go(-(window.history.length - 1));        
                }
                else
                    window.location.replace("./playtimeout.html");
            }
            else
            {
                window.location.replace("./playtimeout.html");
            }
        }


        //------------------------------------------------------------------------------
        // launchNzPlayer
        //! Start  webplayer
        //!
        //! @param [in] app             App to launch
        //! @param [in] orientation     Orientation for app
        //------------------------------------------------------------------------------
        function launchNzPlayer(app, orientation) {
            let authId      = "get auth_id from Netzyn and put here";
            const appServer = "";
            const extraParam= '';

            console.log("Launching player for app: " + app + " in orientation: " + orientation);

            //Call the player with the correct orientation
            NzPlayerWebBrowser(
                appServer,
                'where_to_put_the_video',
                app,
                orientation == 'P' ? 'portrait' : 'landscape',
                encodeURIComponent(authId),
                encodeURIComponent(getUserName()),
                encodeURIComponent(extraParam),
                callbackWebPlayerStatus
            );

            g_WaitForStartTimerId = setTimeout(waitForStart, g_WaitForStartTimeout);

        }

        startNzPlayer();
    </script>
</body>

</html>
