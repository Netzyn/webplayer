<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netzyn</title>
    <script src="../NzPlayerWebBrowser.js?cachebuster=Math.random()"></script>    
    <!-- <script>
        var scriptPath = "../NzPlayerWebBrowser.js?var="; // Example variable
        scriptPath += Math.random();
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = scriptPath;
        document.head.appendChild(script);
    </script>         -->

    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <script async crossorigin
        src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"
        ></script>

    <style>
        :root {
            /* --height-dvh: 100vh; */
            --width-dvw: 100%;
            --height-dvh: 100%;
        }
        body,
        html {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--width-dvw);
            height: var(--height-dvh);
            font-family: Arial, sans-serif;
            background-color: #01203a !important;
        }

        .box {
            background: #01203a;
            object-fit: fill;
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        video {
            background: black;
            object-fit: fill;
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        /* Top bar styling */
        .top-bar {
            width: 100%;
            height: 50px;
            /* background-color: #01203a; */
            background-color: #FFFFFF;
            color: #fff;
            flex-direction: row;
            display: flex;
            justify-content: space-between;
            /* Distribute buttons evenly */
            align-items: center;
            /* Align items vertically in the center */
            position: fixed;
            /* top: 0; */ /* bar at top */
            bottom: 0; /* bar at bottom */
            left: 0;
            z-index: 1000;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            /* Add some padding for spacing */
        }

        .sub-bar {
            width: 100%;
            height: 50px;
            display: flex;
            /* background-color: #01203a; */
            background-color: #FFFFFF;
            color: #fff;
            display: flex;
            justify-content: flex-end;
            flex-direction: row;
            /* Distribute buttons evenly */
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px;
            row-gap: 3px;
            /* Add some padding for spacing */
        }


        /* Button styling */
        .start-button {
            padding: 8px 18px;
            color: #000000;
            background-color: #ffffff;
            /* Add a background color for contrast */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .start-button-container {
            padding: 8px 18px;
            color: #000000;
            background-color: #ffffff;
            /* Add a background color for contrast */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-direction: row;
            
            }        

        .install-button {
            gap:3px;
            height: 50%;
            padding: 8px 18px;
            color: #000000;
            /* background-color: #f3cd25; */
            background-color: white;
            /* Add a background color for contrast */
            box-shadow: 1px 1px 3px rgba(136, 136, 136, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            opacity: 100%;
        }

        #app_run {
            /* width: 100%; */
            width: var(--width-dvw);
            height: var(--height-dvh);
        }

        .close-button {
            padding: 4px 9px;
            color: #ffffff;
            background-color: white;
            /* Add a background color for contrast */
            box-shadow: 1px 1px 3px rgba(136, 136, 136, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            opacity: 100%;
        }

        /* For portrait orientation */
        @media screen and (orientation: portrait) {
            .top-bar {
                width: 100%;
                justify-content: flex-start;
                /* Ensure the button is aligned correctly */
            }

            .start-button {
                font-size: 22x;
            }
        }

        /* For landscape orientation */
        @media screen and (orientation: landscape) {
            .top-bar {
                width: 100%;
                justify-content: flex-end;
                /* Ensure the button is aligned correctly */
            }

            .start-button {
                font-size: 22x;
            }

        }
        
        .install-arrow-box {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            font-color: #000000;
            background-color: #ADD8E6;

        }      
        
        #rotatescreenlanscape {
            /* width: 100%; */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            object-fit: cover;
            background: #01203a;
            margin: 0 !important;
            z-index: 9999;
            touch-action: none;


        }

        #rotatescreenportrait {
            /* width: 100%; */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            object-fit: scale-down;
            background: #01203a;
            margin: 0 !important;
            z-index: 9999;
            touch-action: none;
        }
        .content {
            display: flex;
            align-items: center;
            color: white;
            text-align: center;
        }

        /* Payment Popup Overlay */
        .payment-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100dvw;
            height: 100dvh;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .payment-popup.show {
            display: flex;
        }

        /* Popup Content */
        .popup-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 100%;
            max-width: 440px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .popup-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 24px;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-content h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .popup-content p {
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Button Container */
        .button-container {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        @media (min-width: 640px) {
            .button-container {
                flex-direction: row-reverse;
            }
        }

        /* Popup Buttons */
        .popup-btn {
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .continue-btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
        }

        .continue-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
        }

        .continue-btn:active {
            transform: translateY(0);
        }

        .cancel-btn {
            background: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }

        .cancel-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .cancel-btn:active {
            background: #f3f4f6;
        }

        /* Close button */
        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Focus styles for accessibility */
        .popup-btn:focus,
        .close-btn:focus,
        .demo-btn:focus {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* Credit card icon */
        .credit-card-icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .demo-card .credit-card-icon {
            stroke: white;
        }

        .popup-icon .credit-card-icon {
            stroke: #2563eb;
        }

        /* Responsive adjustments */
         /* Mobile optimizations */
         @media (max-width: 640px) {
            .popup-content {
                padding: 24px 20px;
                margin: 16px;
                width: calc(100% - 32px);
            }
            
            .popup-btn {
                min-height: 52px;
                font-size: 16px;
                padding: 16px 24px;
            }
            
            .button-container {
                gap: 16px;
                margin-top: 24px;
            }
            
            .popup-content h3 {
                font-size: 18px;
            }
            
            .popup-content p {
                font-size: 14px;
                margin-bottom: 24px;
            }
        }
        
        /* Small mobile screens */
        @media (max-width: 480px) {
            .payment-popup {
                padding: 12px;
                width: 95dvw;
            }
            
            .popup-content {
                padding: 20px 16px;
                margin: 12px;
                width: calc(100% - 24px);
            }
            
            .popup-btn {
                min-height: 56px;
                font-size: 17px;
            }
        }

        apple-pay-button {
        --apple-pay-button-width: 150px;
        --apple-pay-button-height: 30px;
        --apple-pay-button-border-radius: 3px;
        --apple-pay-button-padding: 0px 0px;
        --apple-pay-button-box-sizing: border-box;
        }

    </style>
</head>

<body>
    <div id="app_run" >
        <img id="rotatescreenlanscape" src="assets/rotate-L.gif" />
        <img id="rotatescreenportrait" src="assets/rotate-P.gif" />
        <div class="top-bar" id="apprun_topbar">
            <div style="justify-content: flex-start;" class="sub-bar">
                <div class="app-icon" style="place-items: center;margin-top: 5px;" id="netzyn_logo="><img src="assets/netzyn_logo-05.svg" width="75" height="30"/></div>
            </div>

            <div class="sub-bar">
                <div class="start-button-container">
                    
                    <img src="assets/timer.svg">
                    <button class="start-button" style="padding-right: 0%;margin-right: 0%;padding-left: 0%;margin-left: 10%;" id="timer">5:00</button>
                </div>            
                <button style="display: flex; align-items: center; gap: 5px; margin-right: 10px;border: none;" class="install-button" id="install" onclick="handleInstall()">
                    <img src="assets/install.svg" alt="Install Icon" style="height: 16px; width: 16px;">
                    Install
                </button>
                
                <button style="margin-right: 20px;border: none;" class="close-button" id="close" onclick="handleOnClick()"><img src="assets/XButton.svg"/></button>
                <p></p>
            </div>
        </div>

        <div visibility: visible class="box" id="where_to_put_the_video" object-fit="fill" background="black"
            tabindex="-1"></div>

    </div>
    <div id="paymentPopup" class="payment-popup">
        <div class="popup-content">
            <button class="close-btn" onclick="cancelPayment()" aria-label="Close">
                ×
            </button>

            <div class="popup-icon">
                <svg class="credit-card-icon" viewBox="0 0 24 24">
                    <rect width="20" height="14" x="2" y="5" rx="2"/>
                    <line x1="2" x2="22" y1="10" y2="10"/>
                </svg>
            </div>

            <h3>Payment Request</h3>
            <p>You started a payment from the app. Click continue to proceed with your transaction.</p>

            <div class="button-container">
                <button id="continuePaymentBtn" class="popup-btn continue-btn">
                    Continue Payment
                </button>
                <button class="popup-btn cancel-btn" onclick="cancelPayment()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
      
    <script>
        let g_WaitForStartTimerId       = 0;                //!< Timeout waiting for user to click the "Enjoy the games" play button
        let g_WaitForStartTimeout       = 10000;            //!< Timeout duration for play button click 10seconds
        let g_WaitForAppActiveId        = 0;                //!< Timeout waiting for NzPlayerWebBrowser to callback with NZWEBPLAYER_APPACTIVE
        let g_WaitForAppActiveTimeout   = 10000;            //!< Timeout duration for NZWEBPLAYER_APPACTIVE from NzPlayerWebBrowser
        let g_BackOnClose               = true;             //!< Flag to control behaviour, TRUE - history.back() on closing
        let g_buttonStart               = null;             //!< Start button to play audio/video
	    let g_didResize                 = false;            //!< Flag to indicate if user rotated device to correct orientation
        let g_timeLeft                  = 300;              //!< Current app demo time remaining (stored/read from localStorage)
        let OID_APP                      = null;             //!< OID of app
        let OID_1                        = null;             //!< seondary OID of app if any

        function detectRotationToPortrait(timeoutId) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Check if it switched to portrait
            if (width < height) {
                console.log("Device rotated to Portrait - Showing screen cover");
		        g_didResize = true;
                const element = document.getElementById("rotatescreenportrait");
                element.style.display = "none"; // Hide the cover
                element.remove(); // Optionally remove the element

                clearTimeout(timeoutId); // Stop the timeout (no redirect)
                //alert("Device rotated to portrait, launching player...");

                // Initialize video player after rotation is detected
                initializeV(); // Call your video initialization function (if any)

                console.log("detectRotationToPortrait In orientation: portrait");
                // Now that the rotation is handled, launch the player
                launchNzPlayer(app);
            }

        }
        function detectRotationToLandscape(timeoutId) {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Check if it switched to portrait
            if (width > height) {
                console.log("Device rotated to LandScape - Showing screen cover");
		        g_didResize = true;
                const element = document.getElementById("rotatescreenlanscape");
                element.style.display = "none"; // Hide the cover
                element.remove(); // Optionally remove the element

                clearTimeout(timeoutId); // Stop the timeout (no redirect)
                //alert("Device rotated to portrait, launching player...");

                // Initialize video player after rotation is detected
                initializeV(); // Call your video initialization function (if any)

                console.log("detectRotationToLandscape In orientation: landscape");
                // Now that the rotation is handled, launch the player
                launchNzPlayer(app); 
            }

        }
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
        }

        function initializeV()
        {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            const topBar = document.querySelector(".top-bar");
            const appRun = document.getElementById("app_run");
            const playArea = document.getElementById("where_to_put_the_video");
            let bBarTop = false; // TODO check if bar at top or bottom, but the quick method is to hard code it!

            if(topBar == null)
                return;

            if(bBarTop)
            {
                if (window.matchMedia("(orientation: portrait)").matches) {
                    // Portrait: Adjust height minus toolbar
                    const topBarHeight = topBar.offsetHeight;
                    appRun.style.width = screenWidth + "px";
                    appRun.style.height = (screenHeight - topBarHeight) + "px";
                    playArea.style.width = screenWidth + "px";
                    playArea.style.height = (screenHeight - topBarHeight) + "px";
                    appRun.style.marginTop = `${topBarHeight}px`; // Fixed syntax
                } else {
                    // Landscape: Adjust width minus toolbar
                    const topBarWidth = topBar.offsetWidth;
                    appRun.style.width = `${screenWidth - topBarWidth}px`;
                    appRun.style.height = `${screenHeight}px`;
                    playArea.style.width = `${screenWidth - topBarWidth}px`;
                    playArea.style.height = `${screenHeight}px`;
                    appRun.style.marginLeft = `${topBarWidth}px`; // Fixed syntax
                }
            }
            else
            {
                    const topBarHeight = topBar.offsetHeight;
                    appRun.style.width = screenWidth + "px";
                    appRun.style.height = (screenHeight - topBarHeight) + "px";
                    playArea.style.width = screenWidth + "px";
                    playArea.style.height = (screenHeight - topBarHeight) + "px";
                    appRun.style.marginBottom = `${topBarHeight}px`; // Fixed syntax
            }
        }

        window.addEventListener("load", () => {
            initializeV();
            window.addEventListener('resize',function(){
                //when the browser window is resized; recalculate
                initializeV();
            });            

        });

        let app             = new URLSearchParams(window.location.search).get("app");
        let orientation     = new URLSearchParams(window.location.search).get("orient");
        let install         = new URLSearchParams(window.location.search).get("install");
        let install_ios     = new URLSearchParams(window.location.search).get("install_ios");
        let backOnClose     = new URLSearchParams(window.location.search).get("back");
        let no_install      = (install == null || install =="");
        let no_install_ios  = (install_ios == null || install_ios =="");

        if(backOnClose == null )
            g_BackOnClose = false;
        else if(backOnClose=="true")
            g_BackOnClose = true;
        else
            g_BackOnClose = false;

        if(app == null || app == "")
        {
            const alertMsg = "App url param is missing";
        }

        if(orientation == null || orientation == "")
            orientation = "L";

        // Handle missing install links
        if (no_install && no_install_ios) {
            console.log("App install url missing");
        } else if (no_install && !no_install_ios) {
            if (isIOS()) {
                install = install_ios;
            } else {
                console.log("Android install URL missing and device is not iOS");
            }
        } else if (!no_install && no_install_ios) {
            // Use Android link (already in `install`)
            // Nothing needs to change
        } else {
            // Both links present
            if (isIOS()) {
                install = install_ios;
            }
        }

        if(localStorage != null && app != null)
            g_timeLeft = localStorage.getItem(app);

        //*************************************************************************
        // for this example, ignore the save time and always start at 300seconds time remaining
        g_timeLeft = 300
        //*************************************************************************

        const timerDisplay = document.getElementById("timer");

        function updateTimer() {
            const minutes = Math.floor(g_timeLeft / 60);
            const seconds = g_timeLeft % 60;
            timerDisplay.src = "./assets/timer.svg";
            timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            g_timeLeft--;

            //*************************************************************************
            // for this example, disable saving the time remaining
            // if (localStorage != null)
            //     localStorage.setItem(app, g_timeLeft <= 0 ? 0 : g_timeLeft);
            //*************************************************************************

            if (g_timeLeft <= 0) { 
                const installButton = document.getElementById("install");
                console.log("pre_applaunch:Fshutdown_webnavigateToPage3:setinterval installbutton=", installButton);

                NzPlayerWebBrowserPauseMedia();
                const alertMsg = "Demo time has been exhausted";
                alert(alertMsg);

                if(installButton != null)
                    installButton.click();
                else
                {
                    window.close();
                    goBack();
                }
            }
            else
                setTimeout(updateTimer, 1000);

        }

        const closeButton = document.getElementById("close");
        if(closeButton != null)
        {
            closeButton.onclick = () => {
                console.log("apprun_close onclick");
                window.close();
                goBack();
            };
        }
        
        const installButton = document.getElementById("install");
        if(installButton != null)
        {
            if(install == null || install == "")
            {
                if(isIOS())
                    install = "https://apps.apple.com";
                else
                    install = "https://play.google.com";
            }

            //installButton.onclick = () => window.location.href = `${install}`;
            installButton.onclick = () => {
                window.open(install, "_blank");
                window.close();
                goBack();
            };
        }
        

        function showStartButton()
        {
            // This method is called on receiving APPACTIVE callback, so stop the timer waiting for it
            clearTimeout(g_WaitForAppActiveId);
            g_WaitForAppActiveId = 0;

            const elementForVideo="where_to_put_the_video";

            if(g_buttonStart == null)
            {
                // start timeout to wait for start button to be clicked
                g_WaitForStartTimerId = setTimeout(timeoutWaitForStart, g_WaitForStartTimeout);

                let bBarTop = false; // TODO check if bar at top or bottom, but the quick method is to hard code it!

                console.log("Create PLAY button for browsers's autoplay protection");

                let elementDiv  = document.getElementById(elementForVideo);
                // const topBar    = document.querySelector(".top-bar");
                // const appRun    = document.getElementById("app_run");
                // const playArea  = document.getElementById("where_to_put_the_video");
                var left        = 0;
                var top         = 0;
                var fontsize    = 50;
                var alpha       = 0.75;

                const divComputedStyle = window.getComputedStyle(elementDiv);

                g_buttonStart = document.createElement('button');
    //                button.textContent = '\u25BA'; // glyph black right-pointing pointer
                g_buttonStart.textContent          = 'Enjoy the game! \u25B7'; // glyph white right-pointing triangle
                g_buttonStart.style.fontSize       = fontsize + "px"
                g_buttonStart.style.position       = "absolute"
                g_buttonStart.style.width          = elementDiv.style.width  ? elementDiv.style.width  : divComputedStyle.width; //"200px"
                g_buttonStart.style.height         = elementDiv.style.height ? elementDiv.style.height : divComputedStyle.height; //"200px"
                g_buttonStart.style.top            = top + "px";
                g_buttonStart.style.left           = left + "px";
                g_buttonStart.style.border         = "none";
                g_buttonStart.style.color          = "rgb(255, 255, 255)";
                g_buttonStart.style.backgroundColor= `rgba(0, 0, 0, ${alpha})`;
                    
                console.log("divComputedStyle.width  = ", divComputedStyle.width);
                console.log("divComputedStyle.height = ", divComputedStyle.height);
                //console.log("divComputedStyle = ", divComputedStyle);
                console.log(`divwidth=${elementDiv.style.width}, height=${elementDiv.style.height} top=${elementDiv.style.top}, left=${elementDiv.style.left}`)
                
                // Add the button to the container
                elementDiv.appendChild(g_buttonStart);

                g_buttonStart.onclick = () => {
                    clearTimeout(g_WaitForStartTimerId);
                    g_WaitForStartTimerId = 0;

                    NzPlayerWebBrowserPlayMedia(NZWEBPLAYER_MEDIA_AUDIO);
                    NzPlayerWebBrowserPlayMedia(NZWEBPLAYER_MEDIA_VIDEO);
                
                    updateTimer(); // start timer counting down

                    g_buttonStart.remove();
                }
            }

        }


        //------------------------------------------------------------------------------
        // callbackWebPlayerStatus
        //! WebPlayer callback with status
        //!
        //! @param [in] statusId    Event status ID
        //------------------------------------------------------------------------------
        function callbackWebPlayerStatus(statusId, data)
        {
            console.log("callbackWebPlayerStatus statusId=", NzPlayerWebBrowserCallbackToString(statusId), " (", statusId, ")");
            let bClose = false;

            switch(statusId)
            {
                case NZWEBPLAYER_EXIT_UNSUPPORTED_BROWSER:
                    alert("Sorry, this browser is not supported.");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_INVALID_AUTHID:
                    alert("ERROR Invalid auth_id. Check auth_id passed to NzPlayerWebBrowser()!");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_INVALID_DIV:
                    alert("ERROR Invalid HTML div. Check div passed to NzPlayerWebBrowser()!");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_NO_APP:
                    alert("ERROR Invalid app name. Check app name passed to NzPlayerWebBrowser()!");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_VERSION_MISMATCH:
                    alert("ERROR this version of NzPlayerWebBrowser.js is not supported by server!");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_LAUNCH:
                    alert("ERROR launching app!");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_ERROR_POOR_NETWORK:
                    alert("ERROR current network is unsuitable to reliably run app");
                    bClose = true;
                    break;

                case NZWEBPLAYER_EXIT_SERVER_NOT_AVAILABLE:
                    alert("ERROR no server is available");
                    bClose = true;
                    break;

                case NZWEBPLAYER_SHUTDOWN:
                    alert("App has shutdown");
                    bClose = true;
                    break;

                case NZWEBPLAYER_RECVDATA:
                    handleRecvData(data);
                    return;
                    break;

                case NZWEBPLAYER_APPACTIVE:
                    console.log("callbackPlayerStatus first video frame");
                    showStartButton();
                    break;

                // for this example we want to print/show something for all callbacks!
                case NZWEBPLAYER_VERSION:
                    console.log("callbackPlayerStatus Version : " + data);
                    break;

                default:
                    alert("Unparsed callback id=" + statusId);
                    break;
            }

            if(bClose == true)
            {
                console.log("callbackWebPlayerStatus close player because of callback : ", NzPlayerWebBrowserCallbackToString(statusId));
                window.close();
                goBack();
            }

        }


    //************************ For SEND/RECVDATA
        //------------------------------------------------------------------------------
        // base64ToIntArray
        //! Convert from base64 to an array of integers
        //!
        //! @param [in] base64String        String of base64 values to convert
        //!
        //! @return base64String as uint8_t array
        //------------------------------------------------------------------------------
        function base64ToIntArray(base64String) 
        {
            const binaryString = atob(base64String);
            const byteArray = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) 
                byteArray[i] = binaryString.charCodeAt(i);
            
            const intArray = Array.from(byteArray);

            return intArray;
        }

        //------------------------------------------------------------------------------
        // stringToByteArrayOfChars
        //! Convert a string to an array of uint8_t 
        //!
        //! @param [in] str             String to convert to array of uin8_t
        //!
        //! @return str as uint8_t array
        //------------------------------------------------------------------------------
        function stringToByteArrayOfChars(str)
        {
            const byteArray = new Uint8Array(str.length);
            for (let i = 0; i < str.length; i++)
                byteArray[i] += str.charCodeAt(i);

            return byteArray;
        }

        //------------------------------------------------------------------------------
        // intArrayOfCharsToString
        //! Convert an array of ints to a string
        //!
        //! @param [in] intArray             Array of ints to conevert to a String
        //!
        //! @return intArray as string
        //------------------------------------------------------------------------------
        function intArrayOfCharsToString(intArray)
        {
            var str;
            str="";
            for (let i = 0; i < intArray.length; i++)
                str += String.fromCharCode(intArray[i]);

            return str;
        }

        //------------------------------------------------------------------------------
        // uint8ArrayToBase64
        //! Convert an array of uint8 to base64
        //! NOTE array.toBase64() was an unknown function on Chrome Ubuntu 22!!! hence this function!
        //!
        //! @param [in] u8Array             Array of uint8 to conevert to base64
        //!
        //! @return u8Array as base64 string
        //------------------------------------------------------------------------------
        function uint8ArrayToBase64(u8Array) 
        {
            var decoder = new TextDecoder('utf8');
            var b64encoded = btoa(decoder.decode(u8Array));

            return b64encoded;
        }

        //------------------------------------------------------------------------------
        // handleRecvData
        //! Handle app data from cloud app
        //!
        //! @param [in] data        JSON data {string: oidapp, string: oid1, int:param, base64:data}
        //------------------------------------------------------------------------------
        function handleRecvData(data)
        {
            console.log("handleRecvData = ", data );
            var oidApp = data.oidapp;
            var oid1 = data.oid1;
            var param = data.param;
            var data = base64ToIntArray(data.data);
            
            OID_APP = oidApp;
            OID_1 = oid1;

            console.log("oidApp = ", oidApp);
            console.log("oid1   = ", oid1);
            console.log("param  = ", param);
            console.log("data   = ", data);

            switch(param){
                case NZ_PAYMENT_REQUEST:
                    console.log("Recieved Pay request event = ", data);
                    handlePayRequest(data);
                    return;
                    break;
                case NZ_PAYMENT_MERCHANT_VALIDATION_RESPONSE:
                    console.log("Recieved Merchant Validation Result = ", data);
                    handleMerchantValidationResult(data);
                    return;
                    break;
                case NZ_APPLE_PAYMENT_STATUS:
                    console.log("Recieved Apple Pay Status = ", data);
                    handleApplePaymentStatus(data);
                    return;
                    break;
                default:
                    console.log("Recieved param = ", param);
                    break;
            }

            var dataAsString = intArrayOfCharsToString(data);
            console.log("dataAsString  = ", dataAsString);
            alert("Got RecvData :\n" + dataAsString);

            var retData = stringToByteArrayOfChars("Hello, " + dataAsString);

            console.log("retData =",retData);

            // tobase64 does not exist with CHrome on ubuntu 22
            //NzPlayerWebBrowserSendData(oidApp, oid1, param, retData.toBase64() );
            NzPlayerWebBrowserSendData(oidApp, oid1, param, uint8ArrayToBase64(retData));
        }

        // Get popup element
        const popup = document.getElementById('paymentPopup');

        // Function to open popup
        function showPaymentPopup(payDataObj) {
            console.log("showPaymentPopup payDataObj = ", payDataObj);
            popup.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            
            document.getElementById("continuePaymentBtn").onclick = () => {
                closePaymentPopup();
                if(isApplePayAvailable() === false){
                    launchGooglePay(payDataObj);
                }
                else {
                    launchApplePay(payDataObj);
                };
            }
            // Focus management for accessibility
            setTimeout(() => {
                const firstButton = popup.querySelector('.continue-btn');
                if (firstButton) {
                    firstButton.focus();
                }
            }, 300);
        }

        // Function to close popup
        function closePaymentPopup() {
            popup.classList.remove('show');
            document.body.style.overflow = ''; // Restore scroll
        }

        function cancelPayment() {
            closePaymentPopup();
            notifyCancelToServer();
            alert("Payment cancelled.");
        }


        // Close popup when clicking outside
        popup.addEventListener('click', function(e) {
            if (e.target === popup) {
                closePaymentPopup();
                notifyCancelToServer();
                alert("Payment cancelled.");
            }
        });

        // Close popup with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && popup.classList.contains('show')) {
                closePaymentPopup();
                notifyCancelToServer();
                alert("Payment cancelled.");
            }
        });

        // Trap focus within popup for accessibility
        popup.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const focusableElements = popup.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        lastElement.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        firstElement.focus();
                        e.preventDefault();
                    }
                }
            }
        });
       
        function notifyCancelToServer() {
            console.log("User cancelled payment."); 
            let paymentFailed = getPaymentFailureData("AbortError: User closed the Payment Request UI.");
            NzPlayerWebBrowserSendData(null, 
                                        null,
                                        NZ_PAYMENT_FAILURE_RESPONSE,
                                        uint8ArrayToBase64(stringToByteArrayOfChars(JSON.stringify(paymentFailed))));
        }
        
        //------------------------------------------------------------------------------
        // handlePayRequest
        //! Handle payment request from cloud app
        //!
        //! @param [in] payData        JSON payment data
        //------------------------------------------------------------------------------

        function handlePayRequest(payData){
            console.log("handlePayRequest data = ", payData);

            // Convert the byte array to a string
            const payDataString = intArrayOfCharsToString(payData);
            console.log("handlePayRequest payDataString = ", payDataString.length);
            console.log(payDataString);
            // Parse the JSON string to an object
            const payDataObj = JSON.parse(payDataString);
            console.log("handlePayRequest payDataObj = ", payDataObj);
            if(isMobileDevice() === false)
            {
                const errorPayload = {
                    error: true,
                    message: "This feature is only supported on mobile devices.",
                };
                sendPaymentData(NZ_PAYMENT_FAILURE_RESPONSE, errorPayload);
                alert("This feature is only supported on mobile devices.");
                return;
            }

            showPaymentPopup(payDataObj);
        }

        function isApplePayAvailable() {
            // Check if Apple Pay is available
            return window.ApplePaySession && ApplePaySession.canMakePayments();
        }
        
        //------------------------------------------------------------------------------
        // Resolve Merchant Validation promise stored in window object for current apple pay session
        // @param [in] merchantSessionData    Apple pay session Json object sent from cloud app
        // ------------------------------------------------------------------------------
        function handleMerchantValidationResult(merchantSessionData){
            console.log(window._merchantValidationPromise);
            const merchantSessionDataString = intArrayOfCharsToString(merchantSessionData);
            console.log("merchantSessionDataString");
            console.log(merchantSessionDataString);

            const merchantSessionDataObj = JSON.parse(merchantSessionDataString);
            console.log("merchantSessionDataObj", merchantSessionDataObj);

            if (window._merchantValidationPromise) {

                if (merchantSessionData) {
                    window._merchantValidationPromise.resolve(merchantSessionDataObj);
                } else {
                    console.error("Merchant validation failed:", merchantSessionDataObj.error || "unknown error");
                    window._merchantValidationPromise.reject("Validation error");
                }

                window._merchantValidationPromise = null;
            }
        }

        //------------------------------------------------------------------------------
        // Process the final Apple pay payment status sent from the cloud app
        // Ex:
        //     data = {status: "success"}
        //      data = {status: "failure"}
        // @param [in] data    Apple pay payment status data
        //------------------------------------------------------------------------------ 
        async function handleApplePaymentStatus(data){
            console.log("handleApplePaymentStatus data = ", data);

            // Convert the byte array to a string
            const dataString = intArrayOfCharsToString(data);
            console.log("handleApplePaymentStatus dataString = ", dataString.length);
            console.log(dataString);

            // Parse the JSON string to an object
            const paymentData = JSON.parse(dataString);
            console.log("handleApplePaymentStatus paymentData = ", paymentData);

            if(window.applePaymentResponse){
                await window.applePaymentResponse.complete(paymentData.status);
                return window.applePaymentResponse;
            }
            else{
                console.error("No applePaymentResponse found, cannot complete payment");
            }
        }
        
        //------------------------------------------------------------------------------
        // helper function to send payment status data back to the app
        // Example:
        //     paymentStatusParam = NZ_PAYMENT_SUCCESS_RESPONSE & paymentData = {"apiVersion":2,"apiVersionMinor":0,"paymentMethodData":{"type":"CARD","description":"Visa •••• 1234","info":{"cardNetwork":"VISA","cardDetails":"1234"},"tokenizationData":{"type":"PAYMENT_GATEWAY","token":"examplePaymentMethodToken"}}}
        //! @param [in] paymentStatusParam    Payment status parameter to send back to the app
        //! @param [in] paymentData            Payment data to send back to the app
        //------------------------------------------------------------------------------
        function sendPaymentData(paymentStatusParam, paymentData){
            console.log("sendPaymentData paymentData = ", paymentData);
            // Convert the payment data to a string
            const paymentDataString = JSON.stringify(paymentData);
            console.log("sendPaymentData paymentDataString = ", paymentDataString);

            // Convert the string to an array of characters
            const byteArray = stringToByteArrayOfChars(paymentDataString);
            console.log("sendPaymentData byteArray = ", byteArray);

            // Send the data back to the app
            NzPlayerWebBrowserSendData(OID_APP, OID_1, paymentStatusParam, uint8ArrayToBase64(byteArray));
        }

        //************************ END For SEND/RECVDATA

    //************************ For Save/Read/Generate username
        //------------------------------------------------------------------------------
        // randomUserName
        //! Return a string of given length with random letters
        //! EX:
        //!     length=5; return "ABCDE"
        //!     length=5; return "ZWXYZ"
        //!
        //! @param [in] length      - Length of string to return
        //!
        //! @return string of specified length
        //------------------------------------------------------------------------------
        function randomUserName(length) {
            let result = '';
            const characters = 'ab01cdefghijklmnopqrst23uvwxy4z5ABCDEFG67HIJKLMNOPQR89STUVWXYZ'; 
            const charactersLength = characters.length;

            let counter = 0;
            while (counter < length)
            {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
                counter += 1;
            }

            return result;
        }

        //------------------------------------------------------------------------------
        // setCookie
        //! Helper to set a cookie
        //!
        //! @param [in] name        keyname
        //! @param [in] value       data to store
        //! @param [in] days        When cookie will expire
        //------------------------------------------------------------------------------
        function setCookie(name, value, days) 
        {
            let expires = "";
            if (days) 
            {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
        }

        //------------------------------------------------------------------------------
        // getCookie
        //! Helper to get a cookie
        //!
        //! @param [in] name        keyname
        //!
        //! @returns value of cookie
        //! @returns null if cookie not found
        //------------------------------------------------------------------------------
        function getCookie(name) 
        {
            const cookies = document.cookie.split('; ');
            for (let i = 0; i < cookies.length; i++) 
            {
                const parts = cookies[i].split('=');
                if (parts[0] === name) 
                {
                    return parts[1];
                }
            }
            return null;
        }

        //------------------------------------------------------------------------------
        // getUserName
        //! Get username
        //!     If username cookie not found, create a random username and save it as a cookie.
        //!
        //! @returns username string
        //------------------------------------------------------------------------------
        function getUserName() 
        {
            let username = getCookie("Username");
            if(username == null || username == "")
            {
                username = randomUserName(15);

                let days=365;
                console.log("New Username =", username);
                setCookie("Username", username, days);
            }
            return username;
        }
    //************************ END Save/Read/Generate username


        //------------------------------------------------------------------------------
        // startNzPlayer
        //! Start the process to launch the webplayer
        //!     Check for correct orientation, if orientation is not correct allow a few
        //!     seconds for the suer to rotate to the correct orientation.
        //!
        //------------------------------------------------------------------------------
        function startNzPlayer() {
            let app = new URLSearchParams(window.location.search).get("app");
            let orientation = new URLSearchParams(window.location.search).get("orient");
            let bCheckOrientation = true; // set to false to make debugging on desktop easier
            console.log("this is the given orientation" + orientation)

            if(app == null || app == "")
            {
                const alertMsg = "App url param is missing";
                return;
            }

            if (orientation == null || orientation == "")
            {
                if( app.includes("_l"))
                    orientation = "L";
                else
                    orientation = "P";
            }
        
            orientation = orientation.toUpperCase()
            // move to started callback
            //updateTimer();

            const width = window.innerWidth;
            const height = window.innerHeight;
            var bLaunch = true;

            if(bCheckOrientation == true)
            {
                if (orientation == 'L' && height > width) {
                    console.log("navigateToPage3 landscape");
                    const element = document.getElementById("rotatescreenlanscape");
                    const content = document.getElementById("content");

                    element.style.display = "block";
                    window.addEventListener("resize", detectRotationToLandscape);

                    setTimeout(() => {
                        element.style.display = "none";
                        //g_timeLeft += 4;
                        if(localStorage != null)
                            localStorage.setItem(app, g_timeLeft);
                        if(!g_didResize){
                            window.close();
                            goBack();
                        }
                    }, 5000);

                    bLaunch = false;
                }

                if (orientation == 'P' && height < width) {
                    console.log("navigateToPage3 portrait");

                    const element = document.getElementById("rotatescreenportrait");
                    const content = document.getElementById("content");

                    element.style.display = "block";
                    window.addEventListener("resize", detectRotationToPortrait);

                    // The timeout ensures the rotation handling is only after a certain period.
                    setTimeout(() => {
                        element.style.display = "none";
                        //g_timeLeft += 4;
                        if(localStorage != null)
                            localStorage.setItem(app, g_timeLeft);
                        if(!g_didResize){
                            window.close();
                            goBack();
                        }

                    }, 5000);
                    
                    bLaunch = false;
                }
            }

            // Only launch if no rotation needed or after rotation is done
            if (bLaunch) {
                console.log("startNzPlayer In orientation: " + orientation =='P' ? "Portrait" : "Landscape");

                launchNzPlayer(app);
            }
        }

        //------------------------------------------------------------------------------
        // goBack
        //! Either goto to previous page in history, or show a please close page [ mainly for embedded browsers ]
        //! 
        //------------------------------------------------------------------------------
        function goBack()
        {
            if(g_BackOnClose == true)
            {
                if(isIOS())
                    history.go(-(window.history.length - 1));        
                else
                    window.history.back();
            }
            else
                window.location.replace("./pleaseclose.html");

            // if(isIOS())
            // {
            //     if(window.history.length > 1)
            //     {
            //         history.go(-(window.history.length - 1));        
            //     }
            //     else
            //         window.location.replace("./pleaseclose.html");
            // }
            // else
            // {
            //     window.history.back();
            // }
        }
        
        //------------------------------------------------------------------------------
        // timeoutWaitForStart
        //! Called when start button has not been clicked in a timely fashion
        //! 
        //------------------------------------------------------------------------------
        function timeoutWaitForStart()
        {
            console.log("timeoutWaitForStart, show thanks");

            if(isIOS())
            {
                if(window.history.length > 1)
                {
                    history.go(-(window.history.length - 1));        
                }
                else
                    window.location.replace("./playtimeout.html");
            }
            else
            {
                window.location.replace("./playtimeout.html");
            }
        }

        //------------------------------------------------------------------------------
        // timeoutAppActive
        //! Called when appactive callback has not been received in a timely manner...
        //! 
        //------------------------------------------------------------------------------
        function timeoutAppActive()
        {
            console.log("waitForAppActive, show thanks and timeout");

            const elementForVideo="where_to_put_the_video";

            let apprunDiv  = document.getElementById("app_run");
            if(apprunDiv == null)
                return;

            let elementDiv  = document.getElementById(elementForVideo);
            if(elementDiv == null)
                return;
            
            elementDiv.remove();

            const divComputedStyle = window.getComputedStyle(apprunDiv);

            var left        = 0; //Math.floor( parseInt(divComputedStyle.width,10) * 0.4 )+ "px";
            var top         = 0; //Math.floor( parseInt(divComputedStyle.height,10) * 0.4) + "px";;
            var fontsize    = 50;
            var alpha       = 0.75;

            console.log("left  = ", left);
            console.log("top   = ", top);

            console.log("divComputedStyle.width  = ", divComputedStyle.width);
            console.log("divComputedStyle.height = ", divComputedStyle.height);
            console.log(`divwidth=${elementDiv.style.width}, height=${elementDiv.style.height} top=${elementDiv.style.top}, left=${elementDiv.style.left}`)


            let timeoutText = document.createElement('paragraph');
            timeoutText.textContent          = 'Timeout waiting for appactive callback';
            timeoutText.style.fontSize       = fontsize + "px"
            timeoutText.style.position       = "absolute"
            timeoutText.style.width          = elementDiv.style.width  ? elementDiv.style.width  : divComputedStyle.width; //"200px"
            timeoutText.style.height         = elementDiv.style.height ? elementDiv.style.height : divComputedStyle.height; //"200px"
            timeoutText.style.top            = top + "px";
            timeoutText.style.left           = left + "px";
            timeoutText.style.border         = "none";
            timeoutText.style.color          = "rgb(255, 255, 255)";
            timeoutText.style.backgroundColor= `rgba(0, 0, 0, ${alpha})`;
            timeoutText.style.textAlign      = "center";
            
            apprunDiv.appendChild(timeoutText);

            // if(isIOS())
            // {
            //     if(window.history.length > 1)
            //     {
            //         history.go(-(window.history.length - 1));        
            //     }
            //     else
            //         window.location.replace("./playtimeout.html");
            // }
            // else
            // {
            //     window.location.replace("./playtimeout.html");
            // }
        }


        //------------------------------------------------------------------------------
        // launchNzPlayer
        //! Start  webplayer
        //!
        //! @param [in] app             App to launch
        //------------------------------------------------------------------------------
        function launchNzPlayer(app) {
            let authId      = "get auth_id from Netzyn and put here";
            const appServer = "";
            const extraParam= '';

            console.log("launchNzPlayer Launching player for app: " + app );

            window.removeEventListener("resize", detectRotationToLandscape);
            window.removeEventListener("resize", detectRotationToPortrait);

            // start timeout to wait for APPACTIVE callback
            g_WaitForAppActiveId = setTimeout(timeoutAppActive, g_WaitForAppActiveTimeout);

            // Start NzPlayer in the div allocated for it to draw in
            NzPlayerWebBrowser(
                appServer,
                'where_to_put_the_video',
                app,
                '', 
                encodeURIComponent(authId),
                encodeURIComponent(getUserName()),
                encodeURIComponent(extraParam),
                callbackWebPlayerStatus
            );
        }

        startNzPlayer();
    </script>
    <script defer src="./GooglePay.js"></script>
    <script defer src="./ApplePay.js"></script>
</body>

</html>
